#!/bin/bash

# komoot-takeout Linux launcher script
# This script sets up the environment and runs the application

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo "Error: Python 3 is not installed. Please install Python 3 first."
    exit 1
fi

# Check if required system dependencies are available
if ! python3 -c "import gi; gi.require_version('Gtk', '3.0'); from gi.repository import Gtk" &> /dev/null; then
    echo "Error: GTK 3 dependencies are not available."
    echo "Please install them with:"
    echo "  sudo apt install python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.1"
    exit 1
fi

# Check if the virtual environment exists
if [ ! -d "$SCRIPT_DIR/venv" ]; then
    echo "Setting up virtual environment..."
    python3 -m venv "$SCRIPT_DIR/venv" || { echo "Failed to create virtual environment"; exit 1; }
    
    # Create symlink for gi module
    if [ -d "/usr/lib/python3/dist-packages/gi" ]; then
        ln -s /usr/lib/python3/dist-packages/gi "$SCRIPT_DIR/venv/lib/python3.12/site-packages/gi" 2>/dev/null || \
        ln -s /usr/lib/python3/dist-packages/gi "$SCRIPT_DIR/venv/lib/python3*/site-packages/gi" 2>/dev/null
    fi
    
    echo "Installing Python dependencies..."
    "$SCRIPT_DIR/venv/bin/pip" install -r "$SCRIPT_DIR/requirements.txt" || { echo "Failed to install dependencies"; exit 1; }
fi

# Activate virtual environment and run the application
"$SCRIPT_DIR/venv/bin/python" "$SCRIPT_DIR/pywebview_app.py"